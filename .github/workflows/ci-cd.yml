name: CI/CD Pipeline - BoutiqueProd

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  PHP_VERSION: '8.1'
  NODE_VERSION: '18'
  SYMFONY_ENV: 'test'

jobs:
  # =============================================================================
  # 1ï¸âƒ£ TESTS AUTOMATISÃ‰S
  # =============================================================================
  tests:
    name: ðŸ§ª Tests AutomatisÃ©s
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: boutique_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ðŸ˜ Configuration PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, dom, filter, gd, iconv, json, mbstring, pdo
        coverage: xdebug

    - name: ðŸ“¦ Installation Composer
      uses: ramsey/composer-install@v3
      with:
        composer-options: '--no-dev --optimize-autoloader'

    - name: ðŸ“¦ Installation des dÃ©pendances de dÃ©veloppement
      run: composer install --dev --no-interaction --prefer-dist

    - name: ðŸ”§ Configuration de l'environnement de test
      run: |
        cp .env .env.local
        echo "DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:5432/boutique_test?serverVersion=16&charset=utf8" >> .env.local
        echo "APP_ENV=test" >> .env.local

    - name: ðŸ—„ï¸ CrÃ©ation de la base de donnÃ©es de test
      run: |
        php bin/console doctrine:database:create --env=test --if-not-exists
        php bin/console doctrine:migrations:migrate --env=test --no-interaction

    - name: ðŸ§ª ExÃ©cution des tests PHPUnit
      run: |
        php bin/phpunit --coverage-clover=coverage.xml --log-junit=junit.xml --verbose

    - name: ðŸ“Š Upload des rapports de couverture
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

    - name: ðŸ“‹ Upload des rapports de tests
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports
        path: |
          junit.xml
          coverage.xml

  # =============================================================================
  # 2ï¸âƒ£ ANALYSE DE QUALITÃ‰ DE CODE
  # =============================================================================
  code-quality:
    name: ðŸ” Analyse de QualitÃ©
    runs-on: ubuntu-latest
    needs: tests

    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ðŸ˜ Configuration PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl

    - name: ðŸ“¦ Installation des dÃ©pendances
      run: composer install --dev --no-interaction --prefer-dist

    - name: ðŸŽ¨ VÃ©rification du style de code (PHP CS Fixer)
      run: |
        if [ ! -f .php-cs-fixer.php ]; then
          cat > .php-cs-fixer.php << 'EOF'
        <?php
        $finder = PhpCsFixer\Finder::create()
            ->in(__DIR__)
            ->exclude('vendor')
            ->exclude('var')
            ->exclude('public')
            ->exclude('node_modules')
            ->name('*.php');
        $config = new PhpCsFixer\Config();
        return $config
            ->setRules([
                '@PSR12' => true,
                'array_syntax' => ['syntax' => 'short'],
                'ordered_imports' => ['sort_algorithm' => 'alpha'],
                'no_unused_imports' => true,
            ])
            ->setFinder($finder);
        EOF
        fi
        vendor/bin/php-cs-fixer fix --dry-run --diff --verbose

    - name: ðŸ” Analyse statique (PHPStan)
      run: |
        if [ ! -f phpstan.neon ]; then
          cat > phpstan.neon << 'EOF'
        parameters:
            level: 6
            paths:
                - src
            excludePaths:
                - src/Migrations
            ignoreErrors:
                - '#Call to an undefined method#'
            checkMissingIterableValueType: false
        EOF
        fi
        vendor/bin/phpstan analyse --memory-limit=1G

    - name: ðŸ›¡ï¸ Analyse de sÃ©curitÃ© (Security Checker)
      run: |
        composer require --dev symfony/security-checker
        vendor/bin/security-checker security:check

    - name: ðŸ“Š GÃ©nÃ©ration du rapport de qualitÃ©
      run: |
        mkdir -p reports
        cat > reports/quality-report.md << EOF
        # Rapport de QualitÃ© de Code - BoutiqueProd
        
        **Date:** $(date)
        **Commit:** ${{ github.sha }}
        **Branche:** ${{ github.ref_name }}
        
        ## RÃ©sumÃ©
        
        - âœ… Tests unitaires: PassÃ©s
        - âœ… Style de code: Conforme (PSR-12)
        - âœ… Analyse statique: RÃ©ussie (PHPStan niveau 6)
        - âœ… Analyse de sÃ©curitÃ©: Aucune vulnÃ©rabilitÃ© dÃ©tectÃ©e
        
        ## DÃ©tails
        
        ### Tests
        - Couverture de code: Disponible dans les artifacts
        - Rapport JUnit: Disponible dans les artifacts
        
        ### QualitÃ© de code
        - PHPStan: Niveau 6 (strict)
        - PHP CS Fixer: PSR-12
        - Security Checker: Aucune vulnÃ©rabilitÃ©
        
        ## Recommandations
        
        - Maintenir la couverture de code au-dessus de 80%
        - ExÃ©cuter ce pipeline avant chaque dÃ©ploiement
        - RÃ©viser les rapports de couverture rÃ©guliÃ¨rement
        EOF

    - name: ðŸ“‹ Upload du rapport de qualitÃ©
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: reports/quality-report.md

  # =============================================================================
  # 3ï¸âƒ£ CRÃ‰ATION DU LIVRABLE
  # =============================================================================
  build:
    name: ðŸ“¦ CrÃ©ation du Livrable
    runs-on: ubuntu-latest
    needs: [tests, code-quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ðŸ˜ Configuration PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl

    - name: ðŸ“¦ Installation des dÃ©pendances de production
      run: composer install --no-dev --optimize-autoloader --no-interaction

    - name: ðŸ§¹ Nettoyage du cache
      run: php bin/console cache:clear --env=prod --no-debug

    - name: ðŸ“¦ CrÃ©ation de l'archive
      run: |
        VERSION=$(date +"%Y%m%d-%H%M%S")
        ARCHIVE_NAME="BoutiqueProd-${VERSION}.tar.gz"
        
        # CrÃ©er l'archive en excluant les fichiers de dÃ©veloppement
        tar --exclude='.git' \
            --exclude='.github' \
            --exclude='.env.local' \
            --exclude='.env.test' \
            --exclude='var/cache' \
            --exclude='var/log' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='phpunit.xml.dist' \
            --exclude='.php-cs-fixer.php' \
            --exclude='phpstan.neon' \
            --exclude='vendor' \
            --exclude='build' \
            --exclude='reports' \
            --exclude='coverage' \
            -czf "${ARCHIVE_NAME}" .
        
        echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV
        echo "VERSION=${VERSION}" >> $GITHUB_ENV

    - name: ðŸ“‹ CrÃ©ation du manifest
      run: |
        cat > MANIFEST.txt << EOF
        BoutiqueProd - Manifest de Build
        ================================
        
        Version: ${VERSION}
        Date de build: $(date)
        Commit: ${{ github.sha }}
        Branche: ${{ github.ref_name }}
        
        Contenu inclus:
        - Code source de l'application
        - Configuration de production
        - Assets publics
        - Migrations de base de donnÃ©es
        - Documentation
        
        Contenu exclu:
        - Tests unitaires
        - Outils de dÃ©veloppement
        - Cache et logs
        - Fichiers de configuration locale
        
        Installation:
        1. Extraire l'archive sur le serveur
        2. Installer les dÃ©pendances: composer install --no-dev --optimize-autoloader
        3. Configurer la base de donnÃ©es
        4. ExÃ©cuter les migrations: php bin/console doctrine:migrations:migrate
        5. Configurer le serveur web
        
        Support:
        - Documentation: README.md
        - API: /api/doc
        - Logs: var/log/
        EOF

    - name: ðŸ“Š GÃ©nÃ©ration du rapport final
      run: |
        mkdir -p reports
        cat > reports/ci-report.md << EOF
        # Rapport CI/CD - BoutiqueProd
        
        **Date:** $(date)
        **Version:** ${VERSION}
        **Commit:** ${{ github.sha }}
        **Branche:** ${{ github.ref_name }}
        **Statut:** âœ… SUCCÃˆS
        
        ## RÃ©sumÃ© des Ã©tapes
        
        ### 1ï¸âƒ£ Tests automatisÃ©s
        - âœ… PHPUnit: Tous les tests passÃ©s
        - âœ… Couverture de code: GÃ©nÃ©rÃ©e
        - âœ… Rapports: JUnit et Clover
        
        ### 2ï¸âƒ£ Analyse de qualitÃ©
        - âœ… PHPStan: Analyse statique rÃ©ussie
        - âœ… PHP CS Fixer: Style de code conforme
        - âœ… Security Checker: Aucune vulnÃ©rabilitÃ©
        - âœ… Aucun problÃ¨me dÃ©tectÃ©
        
        ### 3ï¸âƒ£ CrÃ©ation du livrable
        - âœ… Archive crÃ©Ã©e: \`${ARCHIVE_NAME}\`
        - âœ… Manifest gÃ©nÃ©rÃ©
        - âœ… PrÃªt pour le dÃ©ploiement
        
        ## Fichiers gÃ©nÃ©rÃ©s
        
        - **Archive:** \`${ARCHIVE_NAME}\`
        - **Manifest:** \`MANIFEST.txt\`
        - **Rapport de qualitÃ©:** \`reports/quality-report.md\`
        - **Rapport CI/CD:** \`reports/ci-report.md\`
        
        ## Prochaines Ã©tapes
        
        1. Tester l'archive sur un environnement de staging
        2. DÃ©ployer en production
        3. Surveiller les logs et mÃ©triques
        
        ---
        *GÃ©nÃ©rÃ© automatiquement par GitHub Actions*
        EOF

    - name: ðŸ“‹ Upload de l'archive
      uses: actions/upload-artifact@v3
      with:
        name: build-artifact
        path: |
          ${{ env.ARCHIVE_NAME }}
          MANIFEST.txt
          reports/

    - name: ðŸ·ï¸ CrÃ©ation d'une release (si tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.ARCHIVE_NAME }}
          MANIFEST.txt
          reports/ci-report.md
        body: |
          ## ðŸš€ Release BoutiqueProd v${{ github.ref_name }}
          
          ### ðŸ“¦ Livrable
          - Archive: `${{ env.ARCHIVE_NAME }}`
          - Version: ${VERSION}
          
          ### âœ… QualitÃ©
          - Tests: Tous passÃ©s
          - Analyse statique: RÃ©ussie
          - SÃ©curitÃ©: Aucune vulnÃ©rabilitÃ©
          
          ### ðŸ“‹ Installation
          Voir le fichier `MANIFEST.txt` pour les instructions d'installation.
        draft: false
        prerelease: false

  # =============================================================================
  # 4ï¸âƒ£ DÃ‰PLOIEMENT (Optionnel)
  # =============================================================================
  deploy:
    name: ðŸš€ DÃ©ploiement
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: ðŸ“¥ Download de l'archive
      uses: actions/download-artifact@v3
      with:
        name: build-artifact

    - name: ðŸš€ DÃ©ploiement (exemple)
      run: |
        echo "ðŸš€ DÃ©ploiement en production..."
        echo "Archive: ${{ env.ARCHIVE_NAME }}"
        echo "Version: ${{ env.VERSION }}"
        # Ici vous pouvez ajouter votre logique de dÃ©ploiement
        # Par exemple : rsync, scp, docker, etc.

  # =============================================================================
  # 5ï¸âƒ£ NOTIFICATION
  # =============================================================================
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [tests, code-quality, build]
    if: always()

    steps:
    - name: ðŸ“¢ Notification de statut
      run: |
        if [ "${{ needs.tests.result }}" == "success" ] && [ "${{ needs.code-quality.result }}" == "success" ]; then
          echo "âœ… Pipeline CI/CD rÃ©ussi!"
          echo "ðŸ“¦ Livrable crÃ©Ã© avec succÃ¨s"
        else
          echo "âŒ Pipeline CI/CD Ã©chouÃ©"
          echo "ðŸ” VÃ©rifiez les logs pour plus de dÃ©tails"
        fi

